# 酒店搜索引擎 - 轻量级架构方案

## 一、方案概述

### 1.1 架构定位
- **目标场景**：初期快速上线，成本控制，2人小团队
- **技术特点**：简化架构，单体应用，便于维护
- **扩展能力**：支持360万-1000万数据规模，可平滑升级
- **成本控制**：月费用约4000元，性价比极高

### 1.2 关键指标
```yaml
性能指标:
  数据规模: 360万酒店（国内210W + 国际150W）
  并发支持: 1000用户并发
  搜索QPS: 峰值500 QPS
  响应时间: 平均<500ms, P95<1s
  可用性: 99%
  缓存命中率: >80%
```

## 二、技术栈选型

### 2.1 核心技术栈
```yaml
基础设施: 阿里云
应用架构: Spring Boot 3.5.7 单体应用
ORM框架: Spring Data JPA + Specification
认证架构: Sa-Token
管道工具: Apache Camel 4.14.0
数据库: RDS PostgreSQL 12 单机版
API文档: SpringDoc 2.8.13  + Therapi JavaDoc 0.15.0
搜索引擎: Elasticsearch 8.19.6 单节点
Elasticsearch分词插件: analysis-ik 版本 8.19.6 + analysis-pinyin 版本8.19.6 + analysis-synonym 版本8.19.6
Hanlp: 模型与算法组成的NLP工具包，主要功能包括分词、词性标注、关键词提取、自动摘要、依存句法分析、命名实体识别、短语提取、拼音转换、简繁转换等等,版本：portable-1.8.6
缓存中间件: Redis  7.x 单节点, Redisson 3.46.0
工具类库:  Lombok 1.18.42 , Hutool 5.8.41 
```

### 2.2 开发工具链
```yaml
开发语言: Java 17
构建工具: Maven 3.9+
容器化: Docker + Docker Compose
版本控制: Git + Gitea
CI/CD: Gitea CI
API文档: SpringDoc OpenAPI 3
测试框架: JUnit 5 + TestContainers
```

## 三、系统架构设计

### 3.1 整体架构图 (随时更新)
``` text
[Client]
  ├─ Web(Next.js)
  └─ Ops(手动触发)

[API - Spring Boot 3 单实例]
  ├─ JobController (Sa-Token 权限)
  ├─ 应用服务层
  └─ OpenAPI (SpringDoc)

[Ingest - Camel 路由 单实例]
  ├─ Quartz 定时
  ├─ direct: 手动触发
  └─ HotelIdsIngestRoute (核心链路, 只用 ctx)

[Domain/Infra/Common]
  ├─ Domain(实体/仓储接口)
  ├─ Repo(MyBatis Plus + HikariCP)
  ├─ Redis(单节点) + Redisson(分布式锁/信号量)
  ├─ ES(单节点) [预留检索]
  ├─ RocketMQ [预留异步]
  └─ HanLP 1.8.6 [预留NLP]

[DB - PostgreSQL 单实例]
  ├─ job_schedule / job_runtime_state
  ├─ sync_log / sync_log_detail
  ├─ hotels
  └─ api_request_log

[Supplier API]
  └─ 酒店供应商接口 (签名Header)

调用链（当前已通）:
Ops/Web -> JobController -> direct:ingest:hotelIds:runOnce
Quartz -> HotelIdsIngestRoute
Route:
  读 job_schedule 参数与开关
  读 job_runtime_state 水位
  构建 ctx（仅 ctx）
  调用 Supplier API (签名Header)
  批量写 hotels，推进水位
  写 api_request_log / sync_log / sync_log_detail
  Redisson 信号量限流（单实例保留）
```



## 四、数据库设计

### 4.1 PostgreSQL核心表结构
```sql
-- 酒店主表 (采用JSONB优化存储)
CREATE TABLE hotels (
    id BIGSERIAL PRIMARY KEY,
    hotel_id BIGINT NOT NULL UNIQUE,
    hotel_data JSONB NOT NULL,
    city_code VARCHAR(20) NOT NULL,
    country_code CHAR(2) NOT NULL,
    location POINT,
    search_vector TSVECTOR GENERATED ALWAYS AS (
        to_tsvector('simple', 
            COALESCE(hotel_data->>'name_cn', '') || ' ' ||
            COALESCE(hotel_data->>'name_en', '') || ' ' ||
            COALESCE(hotel_data->>'brand', '') || ' ' ||
            COALESCE(hotel_data->>'address_cn', '')
        )
    ) STORED,
    star_rating DECIMAL(2,1),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
) PARTITION BY LIST (country_code);

-- 国内酒店分区
CREATE TABLE hotels_cn PARTITION OF hotels 
FOR VALUES IN ('CN');

-- 国际酒店分区  
CREATE TABLE hotels_intl PARTITION OF hotels 
FOR VALUES IN ('US','UK','JP','KR','TH','VN','SG','MY');

-- 关键索引
CREATE INDEX idx_hotels_hotel_id ON hotels(hotel_id);
CREATE INDEX idx_hotels_location ON hotels USING GIST(location);
CREATE INDEX idx_hotels_search ON hotels USING GIN(search_vector);
CREATE INDEX idx_hotels_city ON hotels(city_code);
CREATE INDEX idx_hotels_star ON hotels(star_rating);
CREATE INDEX idx_hotels_data ON hotels USING GIN(hotel_data);

-- 城市基础数据表
CREATE TABLE cities (
    id BIGSERIAL PRIMARY KEY,
    city_code VARCHAR(20) NOT NULL UNIQUE,
    city_data JSONB NOT NULL,
    country_code CHAR(2) NOT NULL,
    location POINT,
    is_hot BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 自定义词典表
CREATE TABLE custom_dictionary (
    id BIGSERIAL PRIMARY KEY,
    word VARCHAR(200) NOT NULL,
    word_type VARCHAR(50) NOT NULL,
    synonyms JSONB,
    pinyin VARCHAR(400),
    weight DECIMAL(3,2) DEFAULT 1.00,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT uk_word_type UNIQUE(word, word_type)
);
```

### 4.2 PostgreSQL性能优化配置
```ini
# postgresql.conf 优化配置
# 内存配置 (基于16GB内存)
shared_buffers = 4GB
effective_cache_size = 12GB
work_mem = 256MB
maintenance_work_mem = 1GB
wal_buffers = 64MB

# 连接配置
max_connections = 200
max_prepared_transactions = 100

# 性能配置
checkpoint_completion_target = 0.9
wal_compression = on
random_page_cost = 1.1
effective_io_concurrency = 200

# 日志配置
log_min_duration_statement = 1000
log_checkpoints = on
log_connections = on
log_disconnections = on
```

## 五、Elasticsearch架构设计

### 5.1 集群配置
```yaml
# elasticsearch.yml
cluster.name: hotel-search-cluster
node.name: ${HOSTNAME}
network.host: 0.0.0.0
http.port: 9200
transport.port: 9300

# 集群发现
discovery.seed_hosts: ["es-node1:9300", "es-node2:9300", "es-node3:9300"]
cluster.initial_master_nodes: ["es-node1", "es-node2", "es-node3"]

# 安全配置
xpack.security.enabled: false
xpack.monitoring.collection.enabled: true

# 性能配置
thread_pool.search.queue_size: 1000
thread_pool.write.queue_size: 1000
indices.memory.index_buffer_size: 20%
indices.queries.cache.size: 20%
```

### 5.2 JVM配置
```bash
# jvm.options
-Xms4g
-Xmx4g
-XX:+UseG1GC
-XX:G1HeapRegionSize=16m
-XX:+UnlockExperimentalVMOptions
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200
-XX:+DisableExplicitGC
-Djava.io.tmpdir=/tmp
```

### 5.3 索引映射设计
```json
{
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "refresh_interval": "30s",
    "index.max_result_window": 100000,
    "analysis": {
      "char_filter": {
        "hotel_mapping": {
          "type": "mapping",
          "mappings": [
            "& => and",
            "帝都 => 北京",
            "魔都 => 上海"
          ]
        }
      },
      "tokenizer": {
        "hotel_pinyin": {
          "type": "pinyin",
          "keep_separate_first_letter": false,
          "keep_full_pinyin": true,
          "keep_original": true,
          "limit_first_letter_length": 16,
          "lowercase": true,
          "remove_duplicated_term": true
        }
      },
      "filter": {
        "hotel_synonym": {
          "type": "synonym",
          "synonyms": [
            "香格里拉,shangri-la,香格里拉酒店",
            "四季酒店,four seasons,四季",
            "万豪,marriott,万豪酒店",
            "希尔顿,hilton,希尔顿酒店"
          ]
        }
      },
      "analyzer": {
        "hotel_analyzer": {
          "type": "custom",
          "char_filter": ["hotel_mapping"],
          "tokenizer": "ik_max_word",
          "filter": ["lowercase", "hotel_synonym"]
        },
        "pinyin_analyzer": {
          "type": "custom",
          "tokenizer": "hotel_pinyin",
          "filter": ["lowercase"]
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "hotel_id": {"type": "long"},
      "hotel_name": {
        "type": "object",
        "properties": {
          "cn": {
            "type": "text",
            "analyzer": "hotel_analyzer",
            "fields": {
              "keyword": {"type": "keyword"},
              "pinyin": {
                "type": "text",
                "analyzer": "pinyin_analyzer"
              }
            }
          },
          "en": {
            "type": "text",
            "analyzer": "english",
            "fields": {"keyword": {"type": "keyword"}}
          }
        }
      },
      "brand": {"type": "keyword"},
      "star_rating": {"type": "float"},
      "hotel_type": {"type": "keyword"},
      "location": {"type": "geo_point"},
      "city": {
        "type": "object",
        "properties": {
          "code": {"type": "keyword"},
          "name_cn": {
            "type": "text",
            "analyzer": "hotel_analyzer",
            "fields": {
              "keyword": {"type": "keyword"},
              "pinyin": {"type": "text", "analyzer": "pinyin_analyzer"}
            }
          }
        }
      },
      "facilities": {"type": "keyword"},
      "address": {
        "type": "text",
        "analyzer": "hotel_analyzer"
      },
      "is_hot": {"type": "boolean"},
      "popularity_score": {"type": "float"}
    }
  }
}
```

## 六、应用服务设计

### 6.1 Spring Boot核心配置
```yaml
# application.yml
server:
  port: 8080
  servlet:
    context-path: /api/v1

spring:
  application:
    name: hotel-search-service
    
  # 数据源配置
  datasource:
    url: jdbc:postgresql://rds-postgresql:5432/hotel_search
    username: ${DB_USERNAME:hotel_user}
    password: ${DB_PASSWORD:}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      idle-timeout: 300000
      max-lifetime: 1200000
      connection-timeout: 20000
      
  # JPA配置
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        
  # Redis配置
  redis:
    host: ${REDIS_HOST:redis-master}
    port: 6379
    timeout: 2000ms
    lettuce:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 5

# Elasticsearch配置
elasticsearch:
  hosts: es-node1:9200,es-node2:9200,es-node3:9200
  connection-timeout: 5000
  socket-timeout: 10000
  
# 缓存配置
cache:
  redis:
    search-result-ttl: 900     # 15分钟
    hot-data-ttl: 3600         # 1小时
    suggestion-ttl: 14400      # 4小时

# 日志配置
logging:
  level:
    com.hotel.search: INFO
    org.springframework.data.elasticsearch: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

### 6.2 核心API接口设计
```java
@RestController
@RequestMapping("/hotels")
@Validated
public class HotelSearchController {
    
    @GetMapping("/search")
    public ResponseEntity<SearchResponse> searchHotels(
        @RequestParam @NotBlank String q,
        @RequestParam(required = false) String cityCode,
        @RequestParam(required = false) String countryCode,
        @RequestParam(required = false) @DecimalMin("0") @DecimalMax("5") BigDecimal minRating,
        @RequestParam(required = false) @DecimalMin("0") @DecimalMax("5") BigDecimal maxRating,
        @RequestParam(required = false) String hotelType,
        @RequestParam(required = false) List<String> facilities,
        @RequestParam(required = false) Double lat,
        @RequestParam(required = false) Double lon,
        @RequestParam(required = false) @Positive Integer radius,
        @RequestParam(defaultValue = "relevance") String sortBy,
        @RequestParam(defaultValue = "1") @Min(1) Integer page,
        @RequestParam(defaultValue = "10") @Min(1) @Max(100) Integer size,
        @RequestParam(defaultValue = "cn") String lang
    ) {
        // 搜索实现
    }
    
    @GetMapping("/suggestions")
    public ResponseEntity<List<SuggestionResponse>> getSuggestions(
        @RequestParam @NotBlank String q,
        @RequestParam(defaultValue = "hotel") String type,
        @RequestParam(defaultValue = "10") @Min(1) @Max(50) Integer limit
    ) {
        // 自动补全实现
    }
    
    @GetMapping("/hot")
    public ResponseEntity<List<HotItemResponse>> getHotItems(
        @RequestParam(defaultValue = "hotels") String type,
        @RequestParam(required = false) String countryCode,
        @RequestParam(defaultValue = "10") @Min(1) @Max(50) Integer limit
    ) {
        // 热门推荐实现
    }
}
```

### 6.3 搜索服务核心实现
```java
@Service
@Slf4j
public class ElasticsearchService {
    
    public SearchResult searchHotels(SearchRequest request) {
        BoolQueryBuilder query = QueryBuilders.boolQuery()
            .must(buildMultiMatchQuery(request.getQuery()))
            .should(buildBoostQueries(request.getQuery()))
            .filter(buildFilters(request));
            
        SearchSourceBuilder sourceBuilder = new SearchSourceBuilder()
            .query(query)
            .from((request.getPage() - 1) * request.getSize())
            .size(request.getSize())
            .sort(buildSortFields(request))
            .aggregation(buildFacetAggregations())
            .timeout(TimeValue.timeValueSeconds(10));
            
        try {
            SearchResponse response = elasticsearchClient.search(
                SearchRequest.of(s -> s
                    .index("hotels")
                    .source(sourceBuilder)
                ), Hotel.class
            );
            
            return parseSearchResponse(response);
        } catch (Exception e) {
            log.error("Elasticsearch search failed", e);
            throw new SearchException("搜索服务暂时不可用", e);
        }
    }
    
    private QueryBuilder buildMultiMatchQuery(String query) {
        return QueryBuilders.multiMatchQuery(query)
            .field("hotel_name.cn", 3.0f)
            .field("hotel_name.en", 3.0f)
            .field("hotel_name.cn.pinyin", 2.0f)
            .field("brand", 2.0f)
            .field("city.name_cn", 2.0f)
            .field("address", 1.0f)
            .type(MultiMatchQueryBuilder.Type.BEST_FIELDS)
            .fuzziness(Fuzziness.AUTO)
            .prefixLength(1)
            .maxExpansions(50);
    }
}
```

## 七、缓存架构设计

### 7.1 Redis配置优化
```ini
# redis.conf
# 内存配置
maxmemory 6gb
maxmemory-policy allkeys-lru

# 持久化配置
save 900 1
save 300 10
save 60 10000
appendonly yes
appendfsync everysec

# 网络配置
tcp-keepalive 300
timeout 0

# 安全配置
requirepass ${REDIS_PASSWORD}
```

### 7.2 缓存策略实现
```java
@Component
public class CacheManager {
    
    @Cacheable(value = "search_results", key = "#request.cacheKey()")
    public SearchResult searchWithCache(SearchRequest request) {
        return elasticsearchService.searchHotels(request);
    }
    
    @Cacheable(value = "hot_cities", key = "'hot_cities_' + #countryCode", 
               unless = "#result.isEmpty()")
    public List<CityInfo> getHotCities(String countryCode) {
        return cityService.getHotCities(countryCode);
    }
    
    @CacheEvict(value = "search_results", allEntries = true)
    @Scheduled(fixedRate = 1800000) // 30分钟清理一次
    public void clearSearchCache() {
        log.info("Search cache cleared");
    }
}
```

## 八、监控与运维

### 8.1 监控指标配置
```yaml
# 应用监控指标
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true


```
```java
// 自定义监控指标
@Component
public class SearchMetrics {
    
    private final Counter searchCounter = Counter.builder("hotel_search_total")
        .description("Total hotel searches")
        .register(Metrics.globalRegistry);
        
    private final Timer searchTimer = Timer.builder("hotel_search_duration")
        .description("Hotel search duration")
        .register(Metrics.globalRegistry);
        
    private final Gauge cacheHitRate = Gauge.builder("cache_hit_rate")
        .description("Cache hit rate")
        .register(Metrics.globalRegistry, this, SearchMetrics::getCacheHitRate);
}
```

### 8.2 日志配置
```xml
<!-- logback-spring.xml -->
<configuration>
    <springProfile name="!prod">
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
            </encoder>
        </appender>
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>
    
    <springProfile name="prod">
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>logs/hotel-search.log</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
                <fileNamePattern>logs/hotel-search.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
                <maxFileSize>100MB</maxFileSize>
                <maxHistory>30</maxHistory>
            </rollingPolicy>
            <encoder class="net.logstash.logback.encoder.LogstashEncoder"/>
        </appender>
        <root level="INFO">
            <appender-ref ref="FILE"/>
        </root>
    </springProfile>
</configuration>
```

## 九、部署方案

### 9.1 Docker化配置
```dockerfile
# Dockerfile
FROM openjdk:17-jre-slim

WORKDIR /app
COPY target/hotel-search-service-*.jar app.jar

# 性能优化参数
ENV JVM_OPTS="-Xms8g -Xmx12g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"

EXPOSE 8080
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s \
  CMD curl -f http://localhost:8080/api/v1/actuator/health || exit 1

ENTRYPOINT ["sh", "-c", "java $JVM_OPTS -jar app.jar"]
```

### 9.2 Elasticsearch Docker Compose配置
```yaml
# 单节点 ES 配置请参考：deploy/elasticsearch/docker-compose.yml
# 包含以下组件：
# - 单节点 Elasticsearch 8.19.6 (4GB内存)
# - Elasticvue Web 管理界面 (profiles: elasticvue)
# - ElasticHD 管理工具 (profiles: elastic-hd)
# - 自定义分词器插件支持
# - 预启动检查脚本

# 快速启动命令：
cd deploy/elasticsearch
./pre-check.sh             # 预启动检查（可选）
./deploy.sh start           # 启动 ES 单节点
./deploy.sh elasticvue      # 启动 Elasticvue 管理界面
./deploy.sh elastic-hd      # 启动 ElasticHD 管理工具

# 故障排查：
./deploy.sh logs            # 查看日志
docker logs elasticsearch  # 查看详细ES日志

# 访问地址：
# Elasticsearch: http://localhost:9200
# Elasticvue: http://localhost:8080
# ElasticHD: http://localhost:9800
```

详细的 Elasticsearch 单节点部署配置和说明请查看：`deploy/elasticsearch/` 目录

## 十、性能优化

### 10.1 应用层优化
```java
// 连接池优化
@Configuration
public class DatabaseConfig {
    
    @Bean
    @Primary
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl(jdbcUrl);
        config.setUsername(username);
        config.setPassword(password);
        config.setMaximumPoolSize(20);
        config.setMinimumIdle(5);
        config.setIdleTimeout(300000);
        config.setMaxLifetime(1200000);
        config.setConnectionTimeout(20000);
        config.setLeakDetectionThreshold(60000);
        return new HikariDataSource(config);
    }
}

// 异步处理优化
@Configuration
@EnableAsync
public class AsyncConfig {
    
    @Bean
    public Executor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(50);
        executor.setQueueCapacity(1000);
        executor.setThreadNamePrefix("hotel-search-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
}
```

### 10.2 系统层优化
```bash
# 系统内核参数优化
echo 'vm.max_map_count=262144' >> /etc/sysctl.conf
echo 'fs.file-max=65536' >> /etc/sysctl.conf
echo 'net.core.somaxconn=65535' >> /etc/sysctl.conf
sysctl -p

# JVM启动参数优化
export JAVA_OPTS="
-Xms8g -Xmx12g
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200
-XX:+UnlockExperimentalVMOptions
-XX:+AggressiveOpts
-XX:+UseFastAccessorMethods
-XX:+OptimizeStringConcat
-Djava.security.egd=file:/dev/urandom
"
```



---




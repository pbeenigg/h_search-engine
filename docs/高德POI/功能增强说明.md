# 高德POI采集系统 - 功能增强说明

本文档说明三个优化功能的实现细节和使用方法。

## 1. Spring Cache缓存城市和类型数据

### 实现内容

#### 1.1 缓存配置类
- **文件**: `AmapCacheConfig.java`
- **缓存实现**: Redis（分布式缓存，支持集群环境）
- **缓存策略**:
  - 城市代码缓存: 24小时过期
  - POI类型缓存: 24小时过期
  - 采集状态缓存: 1小时过期
  - 序列化方式: JSON（支持复杂对象）
  - 事务支持: 已启用

#### 1.2 缓存服务
- **文件**: `AmapCachedDataService.java`
- **缓存内容**:
  - 城市代码数据（全部/按citycode/按adcode/按name）
  - POI类型数据（全部/按typecode/按大类）
- **缓存清理**:
  - 支持按类型清除
  - 支持全部清除
  - 同步完成后自动清除

### 使用方法

```java
// 注入缓存服务
@Autowired
private AmapCachedDataService cachedDataService;

// 查询城市（自动缓存）
List<AmapCitycode> cities = cachedDataService.findAllCitiesWithCode();

// 清除缓存
cachedDataService.evictAllCaches();
```

### API接口

```bash
# 清除所有缓存
POST /api/amap/poi/cache/clear

# 清除城市代码缓存
POST /api/amap/poi/cache/clear?type=citycode

# 清除POI类型缓存
POST /api/amap/poi/cache/clear?type=poitype
```

---

## 2. POI数据增量对比（变更检测）

### 实现内容

#### 2.1 变更检测器
- **文件**: `AmapPoiChangeDetector.java`
- **检测类型**:
  - NEW（新增）
  - UPDATED（更新）
  - DELETED（删除）
  - UNCHANGED（未变更）

#### 2.2 字段对比
- 名称变更
- 类型变更
- 地址变更
- 经纬度变更（容忍0.000001误差）

#### 2.3 变更报告
- 总数统计
- 新增/更新/删除/未变更数量
- 详细变更列表
- 变更摘要

### 使用方法

```java
// 检测变更
AmapPoiChangeDetector.ChangeReport report = changeDetector.detectChanges(newPois);

// 生成摘要
String summary = changeDetector.generateChangeSummary(report);

// 带变更检测的保存（只保存有变更的数据）
Object[] result = poiSinkService.saveInBatchesWithChangeDetection(pois, 1000, syncLogId);
```

### 优势
- **性能优化**: 只保存有变更的POI，减少数据库写入
- **变更追踪**: 详细记录每个字段的变更
- **审计日志**: 可生成完整的变更报告

---

## 3. 采集任务暂停/恢复功能

### 实现内容

#### 3.1 任务管理器
- **文件**: `AmapCollectTaskManager.java`
- **存储**: Redis（支持分布式环境）
- **状态**: IDLE/RUNNING/PAUSED/STOPPED/COMPLETED/FAILED

#### 3.2 任务控制
- 启动任务
- 暂停任务
- 恢复任务
- 停止任务
- 进度更新
- 断点续传

#### 3.3 REST API控制器
- **文件**: `AmapPoiCollectController.java`
- **接口**: 完整的任务控制API

### API接口

```bash
# 1. 启动采集
POST /api/amap/poi/collect

# 2. 暂停任务
POST /api/amap/poi/pause

# 3. 恢复任务
POST /api/amap/poi/resume

# 4. 停止任务
POST /api/amap/poi/stop

# 5. 查询状态
GET /api/amap/poi/status

# 6. 同步城市代码
POST /api/amap/poi/sync/citycode

# 7. 同步POI类型
POST /api/amap/poi/sync/poitype
```

### 使用示例

```bash
# 启动采集
curl -X POST http://localhost:18080/api/amap/poi/collect

# 查看状态
curl http://localhost:18080/api/amap/poi/status

# 暂停任务
curl -X POST http://localhost:18080/api/amap/poi/pause

# 恢复任务
curl -X POST http://localhost:18080/api/amap/poi/resume

# 停止任务
curl -X POST http://localhost:18080/api/amap/poi/stop
```

### 任务状态响应示例

```json
{
  "success": true,
  "status": "RUNNING",
  "batchId": "batch_20231211_150000",
  "traceId": "poi-1702280400000",
  "startTime": "2023-12-11T15:00:00+08:00",
  "totalMetrics": 100,
  "completedMetrics": 35,
  "totalCollected": 12500,
  "currentCity": "110000",
  "currentType": "141201",
  "progress": "35.00%",
  "message": "任务运行中"
}
```

---

## 总结

### 新增文件清单

1. **缓存功能**:
   - `AmapCacheConfig.java` - 缓存配置
   - `AmapCachedDataService.java` - 缓存服务

2. **变更检测**:
   - `AmapPoiChangeDetector.java` - 变更检测器

3. **任务管理**:
   - `AmapCollectTaskManager.java` - 任务管理器
   - `AmapPoiCollectController.java` - REST控制器

### 修改文件清单

1. `AmapPoiRoute.java` - 集成缓存和任务管理
2. `AmapConnectedDataRoute.java` - 同步后清除缓存
3. `AmapPoiSinkService.java` - 增加变更检测保存方法

### 功能优势

✅ **性能提升**: Redis缓存减少数据库查询，变更检测减少写入
✅ **分布式支持**: Redis缓存在集群环境下共享，多实例无需重复查询
✅ **可控性**: 支持任务暂停/恢复/停止，灵活控制采集进度
✅ **可观测性**: 实时查看任务状态和进度
✅ **可靠性**: 基于Redis的分布式任务管理和缓存
✅ **审计性**: 完整的变更追踪和报告
✅ **缓存持久化**: Redis缓存可持久化，重启不丢失

# 高德POI采集系统 - 定时任务配置说明

## 重要变更

**定时任务配置已从`application.yml`迁移至数据库`job_schedule`表管理。**

这种设计的优势：
- ✅ 动态调整：无需重启应用即可修改定时任务
- ✅ 统一管理：所有定时任务配置集中在数据库
- ✅ 开关控制：可通过`enabled`字段快速启用/禁用任务
- ✅ 审计追踪：配置变更可记录到数据库日志

---

## 定时任务列表

系统包含3个定时任务：

| Job Code | 任务名称 | 默认Cron | 说明 |
|----------|---------|----------|------|
| `AMAP_POI_COLLECT` | POI数据采集 | `0 0 0 1 * ?` | 每月1号0点执行 |
| `AMAP_CITYCODE_SYNC` | 城市代码同步 | `0 0 0 1 */3 ?` | 每3个月1号0点执行 |
| `AMAP_POITYPE_SYNC` | POI类型同步 | `0 0 0 1 */3 ?` | 每3个月1号0点执行 |

---

## 配置管理

### 1. 查看当前配置

```sql
SELECT 
    job_code,
    cron_expr,
    enabled,
    max_concurrency,
    batch_size,
    remark
FROM job_schedule
WHERE job_code IN ('AMAP_POI_COLLECT', 'AMAP_CITYCODE_SYNC', 'AMAP_POITYPE_SYNC');
```

### 2. 修改定时任务执行时间

```sql
-- 修改POI采集为每周一凌晨2点执行
UPDATE job_schedule 
SET cron_expr = '0 0 2 ? * MON',
    remark = '每周一凌晨2点执行POI采集'
WHERE job_code = 'AMAP_POI_COLLECT';

-- 修改城市代码同步为每月15号执行
UPDATE job_schedule 
SET cron_expr = '0 0 0 15 * ?',
    remark = '每月15号凌晨执行城市代码同步'
WHERE job_code = 'AMAP_CITYCODE_SYNC';

-- 修改POI类型同步为每半年执行
UPDATE job_schedule 
SET cron_expr = '0 0 0 1 1,7 ?',
    remark = '每年1月和7月1号执行POI类型同步'
WHERE job_code = 'AMAP_POITYPE_SYNC';
```

### 3. 启用/禁用定时任务

```sql
-- 禁用POI采集任务
UPDATE job_schedule SET enabled = false WHERE job_code = 'AMAP_POI_COLLECT';

-- 启用POI采集任务
UPDATE job_schedule SET enabled = true WHERE job_code = 'AMAP_POI_COLLECT';

-- 批量禁用所有高德相关任务
UPDATE job_schedule 
SET enabled = false 
WHERE job_code LIKE 'AMAP_%';
```

### 4. 调整性能参数

```sql
-- 调整POI采集的并发数和批次大小
UPDATE job_schedule 
SET max_concurrency = 5,      -- 最大并发请求数
    batch_size = 2000,         -- 数据库提交批次大小
    http_timeout_sec = 30      -- HTTP超时时间（秒）
WHERE job_code = 'AMAP_POI_COLLECT';
```

---

## Cron表达式说明

Quartz Cron表达式格式：`秒 分 时 日 月 周 [年]`

### 常用示例

```
0 0 0 * * ?           # 每天0点执行
0 0 2 * * ?           # 每天凌晨2点执行
0 0 0 1 * ?           # 每月1号0点执行
0 0 0 ? * MON         # 每周一0点执行
0 0 0 1 */3 ?         # 每3个月1号0点执行
0 0 0 1 1,7 ?         # 每年1月和7月1号执行
0 */30 * * * ?        # 每30分钟执行
0 0 */6 * * ?         # 每6小时执行
```

### Cron字段说明

| 字段 | 允许值 | 特殊字符 |
|------|--------|----------|
| 秒 | 0-59 | , - * / |
| 分 | 0-59 | , - * / |
| 时 | 0-23 | , - * / |
| 日 | 1-31 | , - * ? / L W |
| 月 | 1-12 或 JAN-DEC | , - * / |
| 周 | 1-7 或 SUN-SAT | , - * ? / L # |

**特殊字符说明：**
- `*` : 所有值
- `?` : 不指定值（日和周只能有一个指定，另一个用?）
- `-` : 范围（如10-12）
- `,` : 列举（如1,3,5）
- `/` : 步长（如0/15表示从0开始每15个单位）
- `L` : 最后（如L表示月的最后一天）
- `W` : 工作日
- `#` : 第几个（如6#3表示第3个星期五）

---

## 代码实现

路由在启动时从数据库读取cron配置：

```java
// AmapPoiRoute.java
String poiCollectCron = jobScheduleRepository.findByJobCode(JOB_CODE)
        .filter(JobSchedule::isEnabled)
        .map(JobSchedule::getCronExpr)
        .orElse("0 0 0 1 * ?"); // 默认值

from("quartz://amap/poiCollect?cron=" + poiCollectCron)
        .routeId("route-amap-poi-collect-scheduled")
        .to("direct:amap:poi:collect");
```

**注意事项：**
1. 路由在应用启动时加载cron配置
2. 修改cron配置后需要**重启应用**才能生效
3. 禁用任务（`enabled=false`）后，任务不会触发，但路由仍会创建（只是不会有定时器触发）

---

## 手动触发

即使禁用了定时任务，仍可通过REST API手动触发：

```bash
# 手动触发POI采集
curl -X POST http://localhost:18080/api/amap/poi/collect

# 手动触发城市代码同步
curl -X POST http://localhost:18080/api/amap/poi/sync/citycode

# 手动触发POI类型同步
curl -X POST http://localhost:18080/api/amap/poi/sync/poitype
```

---

## 监控与调试

### 查看任务执行历史

```sql
-- 查看POI采集历史
SELECT 
    id,
    source,
    data_type,
    start_time,
    end_time,
    status,
    total_count,
    success_count,
    failure_count,
    message
FROM map_data_sync_log
WHERE source = 'amap' AND data_type = 'poi'
ORDER BY start_time DESC
LIMIT 10;

-- 查看失败的同步记录
SELECT * FROM map_data_sync_log
WHERE source = 'amap' AND status = 'FAILED'
ORDER BY start_time DESC;
```

### 查看当前运行状态

```bash
# 查询采集任务状态
curl http://localhost:18080/api/amap/poi/status

# 响应示例：
{
  "success": true,
  "status": "RUNNING",
  "batchId": "batch_20231211_150000",
  "progress": "35.00%",
  "totalCollected": 12500,
  "message": "任务运行中"
}
```

---

## 最佳实践

### 1. 生产环境建议

```sql
-- 生产环境：POI采集设置为每月执行，避开业务高峰期
UPDATE job_schedule 
SET cron_expr = '0 0 3 1 * ?',  -- 每月1号凌晨3点
    enabled = true,
    remark = '生产环境：每月1号凌晨3点执行'
WHERE job_code = 'AMAP_POI_COLLECT';

-- 城市和类型数据不常变化，设置为每半年更新
UPDATE job_schedule 
SET cron_expr = '0 0 1 1 1,7 ?',  -- 每年1月和7月1号凌晨1点
    enabled = true
WHERE job_code IN ('AMAP_CITYCODE_SYNC', 'AMAP_POITYPE_SYNC');
```

### 2. 开发/测试环境建议

```sql
-- 开发环境：禁用自动定时任务，改为手动触发
UPDATE job_schedule 
SET enabled = false,
    remark = '开发环境：禁用自动定时，手动触发测试'
WHERE job_code LIKE 'AMAP_%';
```

### 3. 性能调优

```sql
-- 根据服务器性能调整并发数
-- 低配服务器（2核4G）：并发数3-5
-- 中配服务器（4核8G）：并发数5-8
-- 高配服务器（8核16G）：并发数8-10

UPDATE job_schedule 
SET max_concurrency = 5,
    batch_size = 1000
WHERE job_code = 'AMAP_POI_COLLECT';
```

---

## 故障排查

### 问题1：定时任务没有执行

**检查项：**
1. 检查`enabled`字段是否为`true`
2. 检查cron表达式是否正确
3. 检查应用日志是否有报错
4. 确认应用是否已重启（修改配置后需重启）

```sql
-- 检查任务配置
SELECT job_code, cron_expr, enabled 
FROM job_schedule 
WHERE job_code = 'AMAP_POI_COLLECT';
```

### 问题2：任务执行失败

**检查项：**
1. 查看`map_data_sync_log`表中的错误信息
2. 检查API Key是否有效
3. 检查网络连接和防火墙
4. 验证数据库连接

```sql
-- 查看最近的失败记录
SELECT * FROM map_data_sync_log
WHERE status = 'FAILED' AND source = 'amap'
ORDER BY start_time DESC LIMIT 5;
```

### 问题3：修改cron后不生效

**原因：** Camel路由在应用启动时加载cron配置，运行时修改需要重启应用。

**解决方案：** 重启Spring Boot应用。

---

## 总结

- ✅ 所有定时任务配置已迁移至`job_schedule`表
- ✅ 通过SQL语句即可调整定时任务
- ✅ 支持动态启用/禁用任务
- ⚠️ 修改cron配置后需重启应用才能生效
- ✅ 手动触发不受定时任务配置影响

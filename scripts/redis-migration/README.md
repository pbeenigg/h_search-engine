# Redis æ•°æ®è¿ç§»å·¥å…·

ä½¿ç”¨ Redis-shake å·¥å…·å®ç°æœ¬åœ° Redis åˆ°è¿œç¨‹ Redis çš„ä¸€é”®æ•°æ®è¿ç§»ã€‚

## ğŸ“‹ ç›®å½•ç»“æ„

```
redis-migration/
â”œâ”€â”€ README.md              # ä½¿ç”¨è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ redis-shake.toml       # Redis-shake é…ç½®æ–‡ä»¶
â”œâ”€â”€ migrate_redis.sh       # ä¸€é”®è¿ç§»è„šæœ¬
â”œâ”€â”€ redis-shake/           # Redis-shake å·¥å…·ç›®å½•ï¼ˆè‡ªåŠ¨ä¸‹è½½ï¼‰
â”œâ”€â”€ redis-shake.log        # è¿ç§»æ—¥å¿—æ–‡ä»¶ï¼ˆè¿è¡Œåç”Ÿæˆï¼‰
â””â”€â”€ redis-shake-status.json # è¿ç§»çŠ¶æ€æ–‡ä»¶ï¼ˆè¿è¡Œåç”Ÿæˆï¼‰
```

## ğŸ”§ è¿ç§»é…ç½®

### æº Redisï¼ˆæœ¬åœ°ï¼‰
- **åœ°å€**: localhost:6379
- **å¯†ç **: æ— ï¼ˆå¦‚æœ‰å¯†ç è¯·ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼‰
- **æ•°æ®åº“**: æ‰€æœ‰æ•°æ®åº“ï¼ˆ0-15ï¼‰

### ç›®æ ‡ Redisï¼ˆè¿œç¨‹ï¼‰
- **åœ°å€**: 8.210.191.60:6379
- **å¯†ç **: hotel!!search!!engine1234
- **æ•°æ®åº“**: å¯¹åº”æºæ•°æ®åº“

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹å¼ä¸€ï¼šç›´æ¥æ‰§è¡Œï¼ˆæ¨èï¼‰

```bash
cd /Users/pbeenig/Dev/HotelTrip/hotel-search-engine/scripts/redis-migration
./migrate_redis.sh
```

### æ–¹å¼äºŒï¼šä»scriptsç›®å½•æ‰§è¡Œ

```bash
cd /Users/pbeenig/Dev/HotelTrip/hotel-search-engine/scripts
./redis-migration/migrate_redis.sh
```

## ğŸ“ æ‰§è¡Œæ­¥éª¤

è„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **ç¯å¢ƒæ£€æŸ¥**: æ£€æŸ¥å¿…è¦çš„ç³»ç»Ÿå‘½ä»¤ï¼ˆcurlã€tarã€redis-cliï¼‰
2. **è¿æ¥æµ‹è¯•**: æµ‹è¯•æºå’Œç›®æ ‡ Redis çš„è¿æ¥çŠ¶æ€
3. **æ•°æ®ç»Ÿè®¡**: æ˜¾ç¤ºæºå’Œç›®æ ‡ Redis çš„å½“å‰é”®æ•°é‡
4. **ç”¨æˆ·ç¡®è®¤**: ç­‰å¾…ç”¨æˆ·ç¡®è®¤æ˜¯å¦ç»§ç»­è¿ç§»
5. **å·¥å…·ä¸‹è½½**: è‡ªåŠ¨ä¸‹è½½ Redis-shake å·¥å…·ï¼ˆä»…é¦–æ¬¡æ‰§è¡Œï¼‰
6. **æ‰§è¡Œè¿ç§»**: ä½¿ç”¨ Redis-shake æ‰§è¡Œæ•°æ®è¿ç§»
7. **ç»“æœéªŒè¯**: æ˜¾ç¤ºè¿ç§»åçš„æ•°æ®ç»Ÿè®¡

## âš™ï¸ é«˜çº§é…ç½®

### ä¿®æ”¹æº Redis é…ç½®

ç¼–è¾‘ `redis-shake.toml` æ–‡ä»¶ä¸­çš„ `[sync_reader]` éƒ¨åˆ†ï¼š

```toml
[sync_reader]
# é›†ç¾¤æ¨¡å¼
cluster = false  # false=å•æœº, true=é›†ç¾¤

# æºRedisåœ°å€
address = "localhost:6379"

# æºRediså¯†ç ï¼ˆå¦‚æœæœ‰ï¼‰
password = "your-password"

# åŒæ­¥RDBå’ŒAOF
sync_rdb = true  # å…¨é‡æ•°æ®
sync_aof = true  # å¢é‡æ•°æ®ï¼ˆå®æ—¶åŒæ­¥ï¼‰
```

### ä¿®æ”¹ç›®æ ‡ Redis é…ç½®

ç¼–è¾‘ `redis-shake.toml` æ–‡ä»¶ä¸­çš„ `[redis_writer]` éƒ¨åˆ†ï¼š

```toml
[redis_writer]
# é›†ç¾¤æ¨¡å¼
cluster = false  # false=å•æœº, true=é›†ç¾¤

# ç›®æ ‡Redisåœ°å€
address = "8.210.191.60:6379"

# ç›®æ ‡Rediså¯†ç 
password = "hotel!!search!!engine1234"
```

### æ€§èƒ½ä¼˜åŒ–å‚æ•°

ç¼–è¾‘ `redis-shake.toml` æ–‡ä»¶ä¸­çš„ `[advanced]` éƒ¨åˆ†ï¼š

```toml
[advanced]
# RDBå¹¶è¡Œåº¦ï¼ˆæå‡å¤§æ•°æ®é‡è¿ç§»é€Ÿåº¦ï¼‰
rdb_parallel = 4  # å¯æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´ï¼š4/8/16

# æ—¥å¿—é—´éš”ï¼ˆç§’ï¼‰
log_interval = 5
```

### è¿ç§»æ¨¡å¼é€‰æ‹©

**å…¨é‡è¿ç§»**ï¼ˆé»˜è®¤ï¼‰:
```toml
[sync_reader]
sync_rdb = true   # è¿ç§»æ‰€æœ‰ç°æœ‰æ•°æ®
sync_aof = false  # ä¸åŒæ­¥å¢é‡
```

**å…¨é‡+å¢é‡è¿ç§»**ï¼ˆå®æ—¶åŒæ­¥ï¼‰:
```toml
[sync_reader]
sync_rdb = true  # å…ˆè¿ç§»æ‰€æœ‰ç°æœ‰æ•°æ®
sync_aof = true  # ç„¶åæŒç»­åŒæ­¥æ–°æ•°æ®ï¼ˆCtrl+Cåœæ­¢ï¼‰
```

**ä»…å¢é‡è¿ç§»**:
```toml
[sync_reader]
sync_rdb = false  # ä¸è¿ç§»ç°æœ‰æ•°æ®
sync_aof = true   # åªåŒæ­¥æ–°æ•°æ®
```

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: æç¤º "Redis è¿æ¥å¤±è´¥"

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ Redis æœåŠ¡æ˜¯å¦å¯åŠ¨
- æ£€æŸ¥é˜²ç«å¢™å’Œç½‘ç»œé…ç½®
- éªŒè¯å¯†ç æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ç›®æ ‡æœåŠ¡å™¨å®‰å…¨ç»„æ˜¯å¦å¼€æ”¾ 6379 ç«¯å£

### é—®é¢˜ 2: redis-cli æœªæ‰¾åˆ°

**ç—‡çŠ¶**: æç¤º "redis-cli æœªå®‰è£…"

**è§£å†³æ–¹æ¡ˆ**:
```bash
# macOS
brew install redis

# Ubuntu/Debian
sudo apt-get install redis-tools

# CentOS/RHEL
sudo yum install redis
```

### é—®é¢˜ 3: è¿ç§»ä¸­æ–­

**ç—‡çŠ¶**: è¿ç§»è¿‡ç¨‹ä¸­è„šæœ¬ä¸­æ–­

**è§£å†³æ–¹æ¡ˆ**:
- é‡æ–°æ‰§è¡Œè„šæœ¬ï¼ŒRedis-shake æ”¯æŒæ–­ç‚¹ç»­ä¼ 
- æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ `redis-shake.log` æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
- å¦‚éœ€é‡æ–°å¼€å§‹ï¼Œåˆ é™¤ `redis-shake-status.json` æ–‡ä»¶

### é—®é¢˜ 4: ä¸‹è½½å¤±è´¥ï¼ˆæ¨èæ‰‹åŠ¨ä¸‹è½½ï¼‰

**ç—‡çŠ¶**: æç¤º "è‡ªåŠ¨ä¸‹è½½å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé™åˆ¶ï¼‰"

**åŸå› **: GitHub Release ä¸‹è½½é“¾æ¥å¯èƒ½å› ç½‘ç»œé™åˆ¶æ— æ³•é€šè¿‡å‘½ä»¤è¡Œä¸‹è½½

**è§£å†³æ–¹æ¡ˆ - æ‰‹åŠ¨ä¸‹è½½ï¼ˆæ¨èï¼‰**:

1. **è·å–ä¸‹è½½é“¾æ¥**
   
   è„šæœ¬ä¼šè‡ªåŠ¨æ˜¾ç¤ºä¸‹è½½åœ°å€ï¼Œä¾‹å¦‚ï¼š
   ```
   https://github.com/tair-opensource/RedisShake/releases/download/v4.4.2/redis-shake-v4.4.2-darwin-arm64.tar.gz
   ```

2. **æµè§ˆå™¨ä¸‹è½½**
   
   - å¤åˆ¶è„šæœ¬æç¤ºçš„ä¸‹è½½é“¾æ¥
   - åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è¯¥é“¾æ¥
   - ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°

3. **æ”¾ç½®æ–‡ä»¶**
   
   å°†ä¸‹è½½çš„ `.tar.gz` æ–‡ä»¶æ”¾åˆ°è„šæœ¬ç›®å½•ï¼š
   ```bash
   /Users/pbeenig/Dev/HotelTrip/hotel-search-engine/scripts/redis-migration/
   ```
   
   **æ³¨æ„**: ä¸è¦æ”¹åï¼Œä¿æŒåŸå§‹æ–‡ä»¶åï¼Œä¾‹å¦‚ï¼š
   - macOS ARM64: `redis-shake-v4.4.2-darwin-arm64.tar.gz`
   - macOS AMD64: `redis-shake-v4.4.2-darwin-amd64.tar.gz`
   - Linux ARM64: `redis-shake-v4.4.2-linux-arm64.tar.gz`
   - Linux AMD64: `redis-shake-v4.4.2-linux-amd64.tar.gz`

4. **é‡æ–°æ‰§è¡Œè„šæœ¬**
   
   ```bash
   ./migrate_redis.sh
   ```
   
   è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨æ‰‹åŠ¨ä¸‹è½½çš„æ–‡ä»¶

**å…¶ä»–å°è¯•**:
- ä½¿ç”¨ä»£ç†æˆ– VPN
- æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å¤§æ•°æ®é‡è¿ç§»ï¼ˆ10GB+ï¼‰

1. **å¢åŠ å¹¶å‘æ•°**:
   ```toml
   rdb_parallel = 8
   ```

2. **å¢åŠ æ‰¹é‡å¤§å°**:
   ```toml
   batch_size = 500
   target_redis_pipeline_size = 1000
   ```

3. **è°ƒæ•´ç›®æ ‡ Redis é…ç½®**ï¼ˆä¸´æ—¶ï¼‰:
   ```bash
   # å…³é—­æŒä¹…åŒ–ï¼ˆè¿ç§»æœŸé—´ï¼‰
   redis-cli -h 8.210.191.60 -p 6379 -a "hotel!!search!!engine1234" CONFIG SET save ""
   redis-cli -h 8.210.191.60 -p 6379 -a "hotel!!search!!engine1234" CONFIG SET appendonly no
   ```

4. **è¿ç§»å®Œæˆåæ¢å¤æŒä¹…åŒ–**:
   ```bash
   redis-cli -h 8.210.191.60 -p 6379 -a "hotel!!search!!engine1234" CONFIG SET save "900 1 300 10 60 10000"
   redis-cli -h 8.210.191.60 -p 6379 -a "hotel!!search!!engine1234" CONFIG SET appendonly yes
   ```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®è¦†ç›–**: è¿ç§»ä¼šè¦†ç›–ç›®æ ‡ Redis ä¸­ç›¸åŒé”®çš„æ•°æ®
2. **ç”Ÿäº§ç¯å¢ƒ**: å»ºè®®åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œè¿ç§»
3. **å¤‡ä»½**: è¿ç§»å‰å»ºè®®å¤‡ä»½ç›®æ ‡ Redis æ•°æ®
4. **ç½‘ç»œç¨³å®šæ€§**: ç¡®ä¿æºå’Œç›®æ ‡ Redis ä¹‹é—´ç½‘ç»œç¨³å®š
5. **ç£ç›˜ç©ºé—´**: ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´å­˜å‚¨æ—¥å¿—å’Œä¸´æ—¶æ–‡ä»¶
6. **å¯†ç å®‰å…¨**: é…ç½®æ–‡ä»¶ä¸­åŒ…å«å¯†ç ï¼Œæ³¨æ„æ–‡ä»¶æƒé™è®¾ç½®

## ğŸ“š å‚è€ƒèµ„æ–™

- [Redis-shake å®˜æ–¹æ–‡æ¡£](https://github.com/tair-opensource/RedisShake)
- [Redis å®˜æ–¹æ–‡æ¡£](https://redis.io/documentation)

## ğŸ› é—®é¢˜åé¦ˆ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. é”™è¯¯ä¿¡æ¯æˆªå›¾
2. `redis-shake.log` æ—¥å¿—æ–‡ä»¶å†…å®¹
3. Redis ç‰ˆæœ¬ä¿¡æ¯
4. æ“ä½œç³»ç»Ÿå’Œæ¶æ„ä¿¡æ¯

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2024-12-24)
- åˆå§‹ç‰ˆæœ¬
- æ”¯æŒæœ¬åœ°åˆ°è¿œç¨‹çš„ Redis æ•°æ®è¿ç§»
- è‡ªåŠ¨ä¸‹è½½å’Œé…ç½® Redis-shake
- æ”¯æŒæ–­ç‚¹ç»­ä¼ 
- åŒ…å«å®Œæ•´çš„é”™è¯¯æ£€æŸ¥å’Œæ—¥å¿—è®°å½•
